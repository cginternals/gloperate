
#pragma once


#include <memory>

#include <scriptzeug/ScriptContext.h>

#include <gloperate/ext-includes-begin.h>
#include <QScopedPointer>
#include <QMainWindow>
#include <gloperate/ext-includes-end.h>

#include <gloperate-qt/gloperate-qt_api.h>


class Ui_Viewer;

namespace reflectionzeug
{
    class Object;
}

namespace widgetzeug
{
    class MessageStatusWidget;
    class MessageWidget;
    class ScriptPromptWidget;
}

namespace gloperate
{
    class ResourceManager;
    class PluginManager;
    class Painter;
}


namespace gloperate_qt
{


class QtOpenGLWindow;
class DefaultMapping;
class SystemApi;
class TimerApi;
class ViewerApi;
class PluginApi;


/**
*  @brief
*    Main window for gloperate-viewer
*
*    This class contains the main window for a fully-fledged
*    viewer application. It is used by gloperate-viewer and
*    can be used as a base for your own viewer application.
*
*    It contains an OpenGL canvas that displays a gloperate::Painter,
*    a property widget to configure the painter, a console output
*    window, and a scripting console. The main menu allows for
*    the selection of a painter from the available plugins,
*    a choice of the current navigation technique, and additional tools
*    such as screenshot functionality.
*
*    For generic viewer applications, this class may be used as a
*    template. For more specific applications, a usage of the
*    individual components may be more suitable.
*
*    @see QtOpenGLWindow
*/
class GLOPERATE_QT_API Viewer : public QMainWindow
{
    Q_OBJECT


public:
    //@{
    /**
    *  @brief
    *    Constructor
    *
    *  @param[in] parent
    *    Parent widget, can be nullptr
    *  @param[in] flags
    *    Window flags
    */
    Viewer(QWidget * parent = nullptr, Qt::WindowFlags flags = 0);

    /**
    *  @brief
    *    Destructor
    */
    virtual ~Viewer();
    //@}

    //@{
    /**
    *  @brief
    *    Get OpenGL canvas
    *
    *  @return
    *    OpenGL widget (cannot be nullptr)
    */
    QtOpenGLWindow * canvas() const;
    //@}

    //@{
    /**
    *  @brief
    *    Load painter
    *
    *  @param[in] name
    *    Painter name
    *
    *  @remarks
    *    If a painter plugin with this name has been registered,
    *    the painter is created and loaded into the viewer.
    *    Otherwise, nothing happens.
    */
    void loadPainter(const std::string & name);
    //@}

    //@{
    /**
    *  @brief
    *    Get scripting context
    *
    *  @return
    *    Script context
    */
    const scriptzeug::ScriptContext * scriptContext() const;
    scriptzeug::ScriptContext * scriptContext();
    //@}

    //@{
    /**
    *  @brief
    *    Connect scripting API
    *
    *  @param[in] api
    *    Scripting API
    *
    *  @remarks
    *    This adds an reflectionzeug::Object to the scripting
    *    context. The name of the object is made available as a
    *    global variable to access the functions of the object.
    */
    void addScriptApi(reflectionzeug::Object * api);
    //@}


protected:
    void setupMessageWidgets();
    void setupCommandPrompt();
    void setupPropertyWidget();
    void setupDockArea();
    void setupCanvas();
    void setupScripting();
    void updatePainterMenu();


protected slots:
    void on_managePluginsAction_triggered();
    void on_captureImageAction_triggered();
    void onPainterSelected(bool checked);


protected:
    const QScopedPointer<Ui_Viewer> m_ui;

    std::unique_ptr<gloperate::ResourceManager> m_resourceManager;
    std::unique_ptr<gloperate::PluginManager>   m_pluginManager;
    std::unique_ptr<scriptzeug::ScriptContext>  m_scriptContext;

    std::unique_ptr<QtOpenGLWindow>     m_canvas;
    std::unique_ptr<gloperate::Painter> m_painter;
    std::unique_ptr<DefaultMapping>     m_mapping;

    std::unique_ptr<widgetzeug::MessageStatusWidget> m_messagesStatus;
    std::unique_ptr<widgetzeug::MessageWidget>       m_messagesLog;
    std::unique_ptr<widgetzeug::ScriptPromptWidget>  m_scriptPrompt;

    QDockWidget * m_messagLogDockWidget;
    QDockWidget * m_scriptPromptDockWidget;
    QDockWidget * m_propertyDockWidget;

    std::unique_ptr<SystemApi> m_systemApi;
    std::unique_ptr<TimerApi>  m_timerApi;
    std::unique_ptr<ViewerApi> m_viewerApi;
    std::unique_ptr<PluginApi> m_pluginApi;
};


} // namespace gloperate_qt
